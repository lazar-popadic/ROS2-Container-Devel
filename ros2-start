#!/bin/bash

# Start XWayland if not running
if ! pgrep -x "Xwayland" > /dev/null; then
    Xwayland :0 -ac &
    sleep 1
fi

# Allow X11 connections
xhost +local:

# Prepare device arguments
device_args=()

# Check for ttyUSB devices
if compgen -G "/dev/ttyUSB*" > /dev/null; then
    for device in /dev/ttyUSB*; do
        device_args+=("--device=$device:$device")
        echo "Found USB device: $device"
    done
fi

# Check for ttyACM devices (often used for Arduino, serial adapters, etc.)
if compgen -G "/dev/ttyACM*" > /dev/null; then
    for device in /dev/ttyACM*; do
        device_args+=("--device=$device:$device")
        echo "Found ACM device: $device"
    done
fi

# If no devices found, print message but continue
if [ ${#device_args[@]} -eq 0 ]; then
    echo "No ttyUSB or ttyACM devices found. Starting without serial devices."
fi

podman run -it --rm \
    -v /tmp/.X11-unix:/tmp/.X11-unix:rw \
    -v ros2-volume:/home/hostuser \
    -e DISPLAY=:0 \
    -e QT_QPA_PLATFORM=xcb \
    -v /dev/dri:/dev/dri \
    --security-opt label=disable \
    --group-add=keep-groups \
    --network=host \
    "${device_args[@]}" \
    ros2-humble-container
